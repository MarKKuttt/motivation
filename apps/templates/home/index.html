{% extends "layouts/base.html" %}

{% block title %} Dashboard {% endblock title %}

<!-- Specific CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

    <!-- ### $App Screen Content ### -->
    <main class='main-content bgc-grey-100'>
      <div id='mainContent'>
        <div class="row gap-20 masonry pos-r">
          <div class="masonry-sizer col-md-6"></div>
          <div class="masonry-item  w-100">
            <div class="row gap-20">
              <!-- #–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞—â–µ–Ω–∏–π ==================== -->
              <div class='col-md-3'>
                <div class="layers bd bgc-white p-20">
                  <div class="layer w-100 mB-10">
                    <h6 class="lh-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞—â–µ–Ω–∏–π</h6>
                  </div>
                  <div class="layer w-100">
                    <div class="peers ai-sb fxw-nw">
                      <div class="peer peer-greed">
                        <span id="numberOfRequests">0</span> <!--  –§–∏–ª–ª–µ—Ä, –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω –¥–∞–Ω–Ω—ã–º–∏ —Å –±–µ–∫–µ–Ω–¥–∞ --> 
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- #–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π ==================== -->
              <div class='col-md-3'>
                <div class="layers bd bgc-white p-20">
                  <div class="layer w-100 mB-10">
                    <h6 class="lh-1">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π</h6> 
                  </div>
                  <div class="layer w-100">
                    <div class="peers ai-sb fxw-nw">
                      <div class="peer peer-greed">
                        <span id="earliestStartDate">N/A</span> <!-- –§–∏–ª–ª–µ—Ä, –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω –¥–∞–Ω–Ω—ã–º–∏ —Å –±–µ–∫–µ–Ω–¥–∞ -->
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              

              <!-- #–ü–æ—Å–ª–µ–¥–Ω—è—è –¥–∞—Ç–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π ==================== -->
              <div class='col-md-3'>
                <div class="layers bd bgc-white p-20">
                  <div class="layer w-100 mB-10">
                    <h6 class="lh-1">–ü–æ—Å–ª–µ–¥–Ω—è—è –¥–∞—Ç–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π</h6> 
                  </div>
                  <div class="layer w-100">
                    <div class="peers ai-sb fxw-nw">
                      <div class="peer peer-greed">
                        <span id="latestEndDate">N/A</span> <!-- –§–∏–ª–ª–µ—Ä, –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω –¥–∞–Ω–Ω—ã–º–∏ —Å –±–µ–∫–µ–Ω–¥–∞ -->
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              

              <!-- #–û–±—Ä–∞—â–µ–Ω–∏–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è ==================== -->
              <div class='col-md-3'>
                <div class="layers bd bgc-white p-20">
                  <div class="layer w-100 mB-10">
                    <h6 class="lh-1">–û–±—Ä–∞—â–µ–Ω–∏–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h6> 
                  </div>
                  <div class="layer w-100">
                    <div class="peers ai-sb fxw-nw">
                      <div class="peer peer-greed">
                        <span id="todaysRequests">0</span> <!-- –§–∏–ª–ª–µ—Ä, –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω –¥–∞–Ω–Ω—ã–º–∏ —Å –±–µ–∫–µ–Ω–¥–∞ -->
                      </div>
                    
              
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- –ø–æ—á–µ–º—É —Ç–æ —ç—Ç–∞ —à—Ç—É–∫–∞ –ª–æ–º–∞–µ—Ç –≤–∫–ª–∞–¥–∫—É Table üò≠ -->
        <!-- –≥—Ä–∞—Ñ–∏–∫ —Å –¥–∏–Ω–∞–º–∏–∫–æ–π –æ–±—Ä–∞—â–µ–Ω–∏–π –ø–æ –Ω–µ–¥–µ–ª—è–º -->
        <head>  
          <title>Monthly Stats</title>
          <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        </head>
        <div class="bd bgc-white">
          <div class="layers">
            <!-- –ë–ª–æ–∫ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ -->
            <div class="layer w-100 p-20">
              <h3 title="–≠—Ç–æ –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π –ø–æ –Ω–µ–¥–µ–ª—è–º">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –Ω–µ–¥–µ–ª—è–º</h3>
              <label for="tagFilter">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–≥: </label>
              <select id="tagFilter"></select>
              <!-- –ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç select –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ -->
              <label for="timeFilter">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–µ—Ä–∏–æ–¥: </label>
              <select id="timeFilter">
                <option value="year">–≠—Ç–æ—Ç –≥–æ–¥</option>
                <option value="quarter">–≠—Ç–æ—Ç –∫–≤–∞—Ä—Ç–∞–ª</option>
                <option value="month">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</option>
                <option value="week">–≠—Ç–∞ –Ω–µ–¥–µ–ª—è</option>
              </select>

              <div id="line-chart" style="height: 400px;"></div>
            </div>
            <!-- –ë–ª–æ–∫ –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ -->
            <div class="layer w-100 p-20">
              <h3 title="–≠—Ç–æ –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–Ω–æ–º–∞–ª—å–Ω—ã—Ö —Ç–µ–≥–æ–≤ –ø–æ –Ω–µ–¥–µ–ª—è–º. –ß—Ç–æ —Ç–∞–∫–æ–µ –∞–Ω–æ–º–∞–ª—å–Ω—ã–π —Ç–µ–≥? –ü–æ –æ–±—Ä–∞—â–µ–Ω–∏—é –µ—Å—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ. –≠—Ç–æ —Ä–µ–π—Ç–∏–Ω–≥ –æ—Ç 0 –¥–æ 1; 1 –µ—Å–ª–∏ –µ—Å—Ç—å –∏ –≤–ª–æ–∂–µ–Ω–∏–µ –∏ –ª—é–¥–∏ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –∏ —Ç—ç–≥ –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è, –∏–Ω–∞—á–µ 0">–ê–Ω–æ–º–∞–ª–∏–∏ –ø–æ –Ω–µ–¥–µ–ª—è–º</h3>
              <label for="anomalyFilter">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–≥: </label>
              <select id="anomalyFilter"></select>
              
              <div id="anomaly-chart" style="height: 400px;"></div>
            </div>
          </div>
        </div>
      
      
        <script>
          const timeFilter = document.getElementById('timeFilter');

          timeFilter.addEventListener('change', function() {
            const timeValue = this.value;
            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
            const filteredJsonData = filterDataByTime(jsonData, timeValue);
            const filteredAnomalyData = filterDataByTime(anomalyData, timeValue);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
            plotGraph(filteredJsonData, 'line-chart', tagFilter.value);
            plotGraph(filteredAnomalyData, 'anomaly-chart', anomalyFilter.value);
          });


          function filterDataByTime(data, timeValue) {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            let filteredData = {};

            switch(timeValue) {
              case 'week':
                // –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
                const startOfWeek = new Date(currentDate);
                startOfWeek.setDate(currentDate.getDate() - currentDate.getDay() + 1);
                const endOfWeek = new Date(currentDate);
                endOfWeek.setDate(currentDate.getDate() - currentDate.getDay() + 7);

                // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
                for(const date in data) {
                  const yearWeek = date.split('-W');
                  const year = parseInt(yearWeek[0]);
                  const week = parseInt(yearWeek[1]);

                  // –ù–∞–π—Ç–∏ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏
                  const dateOfStartOfWeek = new Date(year, 0, (week - 1) * 7 + 1);

                  if(dateOfStartOfWeek >= startOfWeek && dateOfStartOfWeek <= endOfWeek) {
                    filteredData[date] = data[date];
                  }
                }
                break;

              case 'month':
                for(const date in data) {
                  const yearWeek = date.split('-W');
                  const year = parseInt(yearWeek[0]);
                  const week = parseInt(yearWeek[1]);

                  // –ù–∞–π—Ç–∏ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏
                  const dateOfStartOfWeek = new Date(year, 0, (week - 1) * 7 + 1);

                  if(dateOfStartOfWeek.getMonth() === currentDate.getMonth() &&
                    dateOfStartOfWeek.getFullYear() === currentYear) {
                    filteredData[date] = data[date];
                  }
                }
                break;

              case 'quarter':
                const currentQuarter = Math.floor(currentDate.getMonth() / 3);
                for(const date in data) {
                  const yearWeek = date.split('-W');
                  const year = parseInt(yearWeek[0]);
                  const week = parseInt(yearWeek[1]);

                  // –ù–∞–π—Ç–∏ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏
                  const dateOfStartOfWeek = new Date(year, 0, (week - 1) * 7 + 1);
                  const weekQuarter = Math.floor(dateOfStartOfWeek.getMonth() / 3);

                  if(weekQuarter === currentQuarter && dateOfStartOfWeek.getFullYear() === currentYear) {
                    filteredData[date] = data[date];
                  }
                }
                break;

              case 'year':
                for(const date in data) {
                  const yearWeek = date.split('-W');
                  const year = parseInt(yearWeek[0]);

                  if(year === currentYear) {
                    filteredData[date] = data[date];
                  }
                }
                break;

              default:
                filteredData = { ...data };
            }

            return filteredData;
          }



          const jsonData = {
            '2023-W39': {'Tag1-—Ç–æ—É–æ—Ç–º—É–æ–º—É—Ç–æ–∞–º—Ç–æ—É–º—Ç–æ—É–º—Ç–æ—É–º': 10, 'Tag2': 15},
            '2023-W02': {'Tag1': 20, 'Tag2': 25},
          };
        
          const anomalyData = {
            '2023-W39': {'Tag1': 2, 'Tag2': 1},
            '2023-W02': {'Tag1': 3, 'Tag2': 4},
          };
      
          function getUniqueTags(data) {
            const tags = new Set();
            for (const week of Object.values(data)) {
              for (const tag in week) {
                tags.add(tag);
              }
            }
            return Array.from(tags);
          }
      
          function populateTagFilter(tags, filterElementId) {
            const tagFilter = document.getElementById(filterElementId);
            tagFilter.innerHTML = '<option value="all">–í—Å–µ</option>';
            tags.forEach(tag => {
              tagFilter.innerHTML += `<option value="${tag}">${tag}</option>`;
            });
          }
      
          function plotGraph(data, chartElementId, filterTag = 'all') {
            const traces = [];
            let tags = filterTag === 'all' ? getUniqueTags(data) : [filterTag];
            
            tags.forEach((tag, index) => {
                const trace = {
                    x: [],
                    y: [],
                    mode: 'lines',
                    name: tag.length > 10 ? tag.substring(0, 10) + '...' : tag, // –û–±—Ä–µ–∑–∞—Ç—å –∏–º—è —Ç–µ–≥–∞, –µ—Å–ª–∏ –æ–Ω–æ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ
                    legendgroup: index < 20 ? tag : 'Other'  // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ç–µ–≥–∏ –ø–æ—Å–ª–µ 20 –≤ –æ–¥–Ω—É –≥—Ä—É–ø–ø—É Other
                };
                for (const [week, values] of Object.entries(data)) {
                    trace.x.push(week);
                    trace.y.push(values[tag] || 0);
                }
                traces.push(trace);
            });
  
            function plotGraph_bar(data, chartElementId, filterTag = 'all') {
            const traces = [];
            let tags = filterTag === 'all' ? getUniqueTags(data) : [filterTag];
            
            tags.forEach((tag, index) => {
                const trace = {
                    x: [],
                    y: [],
                    type: 'bar', // –ò–∑–º–µ–Ω–µ–Ω–æ —Å mode –Ω–∞ type –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ bar
                    name: tag.length > 10 ? tag.substring(0, 10) + '...' : tag, 
                    legendgroup: index < 20 ? tag : 'Other'
                };
                for (const [week, values] of Object.entries(data)) {
                    trace.x.push(week);
                    trace.y.push(values[tag] || 0);
                }
                traces.push(trace);
            });

            // Layout –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
            const layout = {
                barmode: 'stack', 
                xaxis: {
                    tickangle: -45,  // –ù–∞–∫–ª–æ–Ω –º–µ—Ç–æ–∫ –ø–æ –æ—Å–∏ X –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
                    automargin: true
                },
                yaxis: {
                    title: '–ó–Ω–∞—á–µ–Ω–∏—è'
                }
            };

            Plotly.newPlot(chartElementId, traces, layout);
        }

        function getUniqueTags(data) {
            const tagsSet = new Set();
            for (const weekValues of Object.values(data)) {
                for (const tag of Object.keys(weekValues)) {
                    tagsSet.add(tag);
                }
            }
            return [...tagsSet];
        }



    const layout = {
        legend: {
            //  –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ª–µ–≥–µ–Ω–¥—ã
        }
    };
    
    Plotly.newPlot(chartElementId, traces, layout);
}

      
          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
          const uniqueTags = getUniqueTags(jsonData);
          populateTagFilter(uniqueTags, 'tagFilter');
          populateTagFilter(uniqueTags, 'anomalyFilter');
          plotGraph(jsonData, 'line-chart');
          plotGraph_bar(anomalyData, 'anomaly-chart');

          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
          const tagFilter = document.getElementById('tagFilter');
          const anomalyFilter = document.getElementById('anomalyFilter');

          tagFilter.addEventListener('change', function() {
            anomalyFilter.value = this.value;
            plotGraph(jsonData, 'line-chart', this.value);
            plotGraph(anomalyData, 'anomaly-chart', this.value);
          });
          anomalyFilter.addEventListener('change', function() {
            tagFilter.value = this.value;
            plotGraph(jsonData, 'line-chart', this.value);
            plotGraph(anomalyData, 'anomaly-chart', this.value);
          });
        </script>

      

      </div>
    </main>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}{% endblock javascripts %}
