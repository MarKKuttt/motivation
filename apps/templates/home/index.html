{% extends "layouts/base.html" %}

{% block title %} Dashboard {% endblock title %}

<!-- Specific CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

    <!-- ### $App Screen Content ### -->
    <main class='main-content bgc-grey-100'>
      <div id='mainContent'>
        <div class="row gap-20 masonry pos-r">
          <div class="masonry-sizer col-md-6"></div>
          <div class="masonry-item  w-100">
            <div class="row gap-20">
              <!-- #–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞—â–µ–Ω–∏–π ==================== -->

            <div class='col-md-3'>
              <div class="layers bd bgc-white p-20">
                  <div class="layer w-100 mB-10">
                      <h6 class="lh-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞—â–µ–Ω–∏–π</h6>
                  </div>
                  <div class="layer w-100">
                      <div class="peers ai-sb fxw-nw">
                          <div class="peer peer-greed">
                            <span id="numberOfRequests">{{ appeal_count }}</span>
                          </div>
                      </div>
                  </div>
              </div>
            </div>


<!-- ... -->



              
              <!-- #–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π ==================== -->
              <div class='col-md-3'>
                <div class="layers bd bgc-white p-20">
                  <div class="layer w-100 mB-10">
                    <h6 class="lh-1">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π</h6> 
                  </div>
                  <div class="layer w-100">
                    <div class="peers ai-sb fxw-nw">
                      <div class="peer peer-greed">
                        <span id="earliestStartDate">{{ earliest_appeal_date }}</span> <!-- –§–∏–ª–ª–µ—Ä, –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω –¥–∞–Ω–Ω—ã–º–∏ —Å –±–µ–∫–µ–Ω–¥–∞ -->
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              

              <!-- #–ü–æ—Å–ª–µ–¥–Ω—è—è –¥–∞—Ç–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π ==================== -->
              <div class='col-md-3'>
                <div class="layers bd bgc-white p-20">
                  <div class="layer w-100 mB-10">
                    <h6 class="lh-1">–ü–æ—Å–ª–µ–¥–Ω—è—è –¥–∞—Ç–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π</h6> 
                  </div>
                  <div class="layer w-100">
                    <div class="peers ai-sb fxw-nw">
                      <div class="peer peer-greed">
                        <span id="latestEndDate">{{ latest_appeal_date }}</span> <!-- –§–∏–ª–ª–µ—Ä, –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω –¥–∞–Ω–Ω—ã–º–∏ —Å –±–µ–∫–µ–Ω–¥–∞ -->
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              

              <!-- #–û–±—Ä–∞—â–µ–Ω–∏–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è ==================== -->
              <div class='col-md-3'>
                <div class="layers bd bgc-white p-20">
                  <div class="layer w-100 mB-10">
                    <h6 class="lh-1">–û–±—Ä–∞—â–µ–Ω–∏–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h6> 
                  </div>
                  <div class="layer w-100">
                    <div class="peers ai-sb fxw-nw">
                      <div class="peer peer-greed">
                        <span id="todaysRequests">{{ appeals_today_count }}</span> <!-- –§–∏–ª–ª–µ—Ä, –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω –¥–∞–Ω–Ω—ã–º–∏ —Å –±–µ–∫–µ–Ω–¥–∞ -->
                      </div>
                    
              
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- –ø–æ—á–µ–º—É —Ç–æ —ç—Ç–∞ —à—Ç—É–∫–∞ –ª–æ–º–∞–µ—Ç –≤–∫–ª–∞–¥–∫—É Table üò≠ -->
        <!-- –≥—Ä–∞—Ñ–∏–∫ —Å –¥–∏–Ω–∞–º–∏–∫–æ–π –æ–±—Ä–∞—â–µ–Ω–∏–π –ø–æ –Ω–µ–¥–µ–ª—è–º -->
        <head>
          <title>Monthly Stats</title>
          <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        </head>
        <div class="bd bgc-white">
          <div class="layers">
            <!-- –ë–ª–æ–∫ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ -->
            <div class="layer w-100 p-20">
              <h3 title="–≠—Ç–æ –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π –ø–æ –Ω–µ–¥–µ–ª—è–º">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –Ω–µ–¥–µ–ª—è–º</h3>
              <label for="tagFilter">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–≥: </label>
              <select id="tagFilter"></select>
              <!-- –ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç select –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ -->
              <label for="timeFilter">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–µ—Ä–∏–æ–¥: </label>
              <select id="timeFilter">
                <option value="year">–≠—Ç–æ—Ç –≥–æ–¥</option>
                <option value="quarter">–≠—Ç–æ—Ç –∫–≤–∞—Ä—Ç–∞–ª</option>
                <option value="month">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</option>
                <option value="week">–≠—Ç–∞ –Ω–µ–¥–µ–ª—è</option>
              </select>
        
              <div id="line-chart" style="height: 400px;"></div>
            </div>
          </div>
        </div>
        
      
        <script>

          const timeFilter = document.getElementById('timeFilter');

          timeFilter.addEventListener('change', function() {
            const timeValue = this.value;
            const filteredJsonData = filterDataByTime(jsonData, timeValue);
            plotGraph(filteredJsonData, 'line-chart', tagFilter.value);
          });


          function filterDataByTime(data, timeValue) {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            let filteredData = {};

            switch(timeValue) {
              case 'week':
                // –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
                const startOfWeek = new Date(currentDate);
                startOfWeek.setDate(currentDate.getDate() - currentDate.getDay() + 1);
                const endOfWeek = new Date(currentDate);
                endOfWeek.setDate(currentDate.getDate() - currentDate.getDay() + 7);

                // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
                for(const date in data) {
                  const yearWeek = date.split('-W');
                  const year = parseInt(yearWeek[0]);
                  const week = parseInt(yearWeek[1]);

                  // –ù–∞–π—Ç–∏ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏
                  const dateOfStartOfWeek = new Date(year, 0, (week - 1) * 7 + 1);

                  if(dateOfStartOfWeek >= startOfWeek && dateOfStartOfWeek <= endOfWeek) {
                    filteredData[date] = data[date];
                  }
                }
                break;

              case 'month':
                for(const date in data) {
                  const yearWeek = date.split('-W');
                  const year = parseInt(yearWeek[0]);
                  const week = parseInt(yearWeek[1]);

                  // –ù–∞–π—Ç–∏ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏
                  const dateOfStartOfWeek = new Date(year, 0, (week - 1) * 7 + 1);

                  if(dateOfStartOfWeek.getMonth() === currentDate.getMonth() &&
                    dateOfStartOfWeek.getFullYear() === currentYear) {
                    filteredData[date] = data[date];
                  }
                }
                break;

              case 'quarter':
                const currentQuarter = Math.floor(currentDate.getMonth() / 3);
                for(const date in data) {
                  const yearWeek = date.split('-W');
                  const year = parseInt(yearWeek[0]);
                  const week = parseInt(yearWeek[1]);

                  // –ù–∞–π—Ç–∏ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏
                  const dateOfStartOfWeek = new Date(year, 0, (week - 1) * 7 + 1);
                  const weekQuarter = Math.floor(dateOfStartOfWeek.getMonth() / 3);

                  if(weekQuarter === currentQuarter && dateOfStartOfWeek.getFullYear() === currentYear) {
                    filteredData[date] = data[date];
                  }
                }
                break;

              case 'year':
                for(const date in data) {
                  const yearWeek = date.split('-W');
                  const year = parseInt(yearWeek[0]);

                  if(year === currentYear) {
                    filteredData[date] = data[date];
                  }
                }
                break;

              default:
                filteredData = { ...data };
            }

            return filteredData;
          }

          var jsonData = {{ jsonData | safe }}


          // const jsonData = {
          //   '2023-W04': {'Tag1': 20, 'Tag2': 25},
          //   '2023-W05': {'Tag221': 10, 'Tag2': 25},
          //   '2023-W03': {'Tag111': 20, 'Tag234': 25},
          //   '2023-W07': {'Tag321': 10, 'Tag2': 25},
          //   '2023-W09': {'Tag221': 10, 'Tag2': 25},
          //   '2023-W08': {'Tag12311': 20, 'Tag234': 25},
          //   '2023-W40': {'Tag1-—Ç–æ—É–æ—Ç–º—É–æ–º': 10, 'Tag2': 15},
          //   '2023-W41': {'Tag1-—Ç–æ—É–æ—Ç–º—É–æ–º': 10, 'Tag2': 15},
          //   '2023-W49': {'Tag1-—Ç–æ—É–æ—Ç–º—É–æ–º': 10, 'Tag2': 15},

          // };
        

      
          function getUniqueTags(data) {
            const tags = new Set();
            for (const week of Object.values(data)) {
              for (const tag in week) {
                tags.add(tag);
              }
            }
            return Array.from(tags);
          }
      
          function populateTagFilter(tags, filterElementId) {
            const tagFilter = document.getElementById(filterElementId);
            tagFilter.innerHTML = '<option value="all">–í—Å–µ</option>';
            tags.forEach(tag => {
              tagFilter.innerHTML += `<option value="${tag}">${tag}</option>`;
            });
          }
      
          function plotGraph(data, chartElementId, filterTag = 'all') {
          const traces = [];
          let tags = filterTag === 'all' ? getUniqueTags(data) : [filterTag];

            
            tags.forEach((tag, index) => {
                const trace = {
                    x: [],
                    y: [],
                    mode: 'lines',
                    name: tag.length > 10 ? tag.substring(0, 10) + '...' : tag, // –û–±—Ä–µ–∑–∞—Ç—å –∏–º—è —Ç–µ–≥–∞, –µ—Å–ª–∏ –æ–Ω–æ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ
                    legendgroup: index < 20 ? tag : 'Other'  // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ç–µ–≥–∏ –ø–æ—Å–ª–µ 20 –≤ –æ–¥–Ω—É –≥—Ä—É–ø–ø—É Other
                };
                for (const [week, values] of Object.entries(data)) {
                    trace.x.push(week);
                    trace.y.push(values[tag] || 0);
                }
                traces.push(trace);
            });
  
            function plotGraph_bar(data, chartElementId, filterTag = 'all') {
            const traces = [];
            let tags = filterTag === 'all' ? getUniqueTags(data) : [filterTag];
            
            tags.forEach((tag, index) => {
                const trace = {
                    x: [],
                    y: [],
                    type: 'bar', // –ò–∑–º–µ–Ω–µ–Ω–æ —Å mode –Ω–∞ type –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ bar
                    name: tag.length > 10 ? tag.substring(0, 10) + '...' : tag, 
                    legendgroup: index < 20 ? tag : 'Other'
                };
                for (const [week, values] of Object.entries(data)) {
                    trace.x.push(week);
                    trace.y.push(values[tag] || 0);
                }
                traces.push(trace);
            });

            // Layout –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
            const layout = {
                barmode: 'stack', 
                xaxis: {
                    tickangle: -45,  // –ù–∞–∫–ª–æ–Ω –º–µ—Ç–æ–∫ –ø–æ –æ—Å–∏ X –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
                    automargin: true
                },
                yaxis: {
                    title: '–ó–Ω–∞—á–µ–Ω–∏—è'
                }
            };

            Plotly.newPlot(chartElementId, traces, layout);
        }

        function getUniqueTags(data) {
            const tagsSet = new Set();
            for (const weekValues of Object.values(data)) {
                for (const tag of Object.keys(weekValues)) {
                    tagsSet.add(tag);
                }
            }
            return [...tagsSet];
        }



    const layout = {
        legend: {
            //  –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ª–µ–≥–µ–Ω–¥—ã
        }
    };
    
    Plotly.newPlot(chartElementId, traces, layout);
}

      
          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
          const uniqueTags = getUniqueTags(jsonData);
          populateTagFilter(uniqueTags, 'tagFilter');
          plotGraph(jsonData, 'line-chart');

          const tagFilter = document.getElementById('tagFilter');

          tagFilter.addEventListener('change', function() {
            plotGraph(jsonData, 'line-chart', this.value);
            // plotGraph(anomalyData, 'anomaly-chart', this.value);
          });
        </script>

<head>
  <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞–Ω–æ–º–∞–ª—å–Ω—ã–º —Ç–µ–≥–∞–º</title>
  <style>
    .redText {
      color: red;
    }
  </style>
</head>
<body>

<div class="bd bgc-white">
  <div class="layers">
    <div class="layer w-100 p-20">
      <h3>–ê–Ω–æ–º–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏</h3>
      <!-- –ú–µ—Å—Ç–æ –¥–ª—è –Ω–∞–¥–ø–∏—Å–∏ –æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
      <div id="lastUpdated"></div>
      <div id="anomalyBarChart" style="height: 400px;"></div>
    </div>
  </div>
</div>

<script>

  var anomalyjson = {{ anomalyjson | safe }}
  const lastUpdatedDate = '2023-09-30';

  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É –≤ –¥–Ω—è—Ö –º–µ–∂–¥—É —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π –∏ –¥–∞—Ç–æ–π –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  const today = new Date();
  const lastUpdated = new Date(lastUpdatedDate);
  const diffInDays = Math.ceil((today - lastUpdated) / (1000 * 60 * 60 * 24));

  // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∞—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  const lastUpdatedDiv = document.getElementById('lastUpdated');
  lastUpdatedDiv.innerHTML = `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${lastUpdatedDate}`;
  
  // –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –≤ –¥–Ω—è—Ö –±–æ–ª—å—à–µ 3, –¥–µ–ª–∞–µ–º —Ç–µ–∫—Å—Ç –∫—Ä–∞—Å–Ω—ã–º
  if (diffInDays > 3) {
    lastUpdatedDiv.classList.add('redText');
  }

  // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–µ–≥–æ–≤ –ø–æ –∞–Ω–æ–º–∞–ª—å–Ω–æ—Å—Ç–∏ –≤ –ø–æ—Ä—è–¥–∫–µ —É–±—ã–≤–∞–Ω–∏—è
  const sortedTags = Object.keys(anomalyjson).sort((a, b) => anomalyjson[b] - anomalyjson[a]);

  // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
  const trace = {
    x: sortedTags,
    y: sortedTags.map(tag => anomalyjson[tag]),
    type: 'bar'
  };

  const layout = {
    title: '–ê–Ω–æ–º–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏',
    xaxis: {
      title: '–¢–µ–≥–∏',
      tickvals: [...Array(sortedTags.length).keys()],
      ticktext: sortedTags,
      tickfont: {
        size: 8
      }
    },
    yaxis: {
      title: '–ó–Ω–∞—á–µ–Ω–∏–µ –∞–Ω–æ–º–∞–ª—å–Ω–æ—Å—Ç–∏'
    }
  };

  Plotly.newPlot('anomalyBarChart', [trace], layout);
</script>
</body>








<head>
  <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–µ–≥–∞–º</title>
</head>
<div class="bd bgc-white">
  <div class="layers">
      <div class="layer w-100 p-20">
          <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–µ–≥–∞–º</h3>
          <!-- <label for="timeFilter">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–µ—Ä–∏–æ–¥: </label>
          <select id="timeFilter"> -->
              <option value="year">–≠—Ç–æ—Ç –≥–æ–¥</option>
              <option value="quarter">–≠—Ç–æ—Ç –∫–≤–∞—Ä—Ç–∞–ª</option>
              <option value="month">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</option>
              <option value="week" selected>–≠—Ç–∞ –Ω–µ–¥–µ–ª—è</option>
          </select>
          <div id="pie-chart" style="height: 400px;"></div>
      </div>
  </div>
</div>
</div>
<script>


  const timeFilterElement = document.getElementById('timeFilter');
  timeFilterElement.addEventListener('change', () => {
      updatePieChart();
  });

  function filterDataByTime(data, timeValue) {
      let filteredData = {};
      const currentDate = new Date();
      const currentYear = currentDate.getFullYear();

      switch(timeValue) {
              case 'week':
                // –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
                const startOfWeek = new Date(currentDate);
                startOfWeek.setDate(currentDate.getDate() - currentDate.getDay() + 1);
                const endOfWeek = new Date(currentDate);
                endOfWeek.setDate(currentDate.getDate() - currentDate.getDay() + 7);

                // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
                for(const date in data) {
                  const yearWeek = date.split('-W');
                  const year = parseInt(yearWeek[0]);
                  const week = parseInt(yearWeek[1]);

                  // –ù–∞–π—Ç–∏ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏
                  const dateOfStartOfWeek = new Date(year, 0, (week - 1) * 7 + 1);

                  if(dateOfStartOfWeek >= startOfWeek && dateOfStartOfWeek <= endOfWeek) {
                    filteredData[date] = data[date];
                  }
                }
                break;

              case 'month':
                for(const date in data) {
                  const yearWeek = date.split('-W');
                  const year = parseInt(yearWeek[0]);
                  const week = parseInt(yearWeek[1]);

                  // –ù–∞–π—Ç–∏ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏
                  const dateOfStartOfWeek = new Date(year, 0, (week - 1) * 7 + 1);

                  if(dateOfStartOfWeek.getMonth() === currentDate.getMonth() &&
                    dateOfStartOfWeek.getFullYear() === currentYear) {
                    filteredData[date] = data[date];
                  }
                }
                break;

              case 'quarter':
                const currentQuarter = Math.floor(currentDate.getMonth() / 3);
                for(const date in data) {
                  const yearWeek = date.split('-W');
                  const year = parseInt(yearWeek[0]);
                  const week = parseInt(yearWeek[1]);

                  // –ù–∞–π—Ç–∏ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏
                  const dateOfStartOfWeek = new Date(year, 0, (week - 1) * 7 + 1);
                  const weekQuarter = Math.floor(dateOfStartOfWeek.getMonth() / 3);

                  if(weekQuarter === currentQuarter && dateOfStartOfWeek.getFullYear() === currentYear) {
                    filteredData[date] = data[date];
                  }
                }
                break;

              case 'year':
                for(const date in data) {
                  const yearWeek = date.split('-W');
                  const year = parseInt(yearWeek[0]);

                  if(year === currentYear) {
                    filteredData[date] = data[date];
                  }
                }
                break;

              default:
                filteredData = { ...data };
            }


      return filteredData;
  }

  function aggregateDataByTags(filteredData) {
      const aggregatedData = {};

      for (const week in filteredData) {
          for (const tag in filteredData[week]) {
              if (!aggregatedData[tag]) aggregatedData[tag] = 0;
              aggregatedData[tag] += filteredData[week][tag];
          }
      }

      return aggregatedData;
  }

  function updatePieChart() {
      const timeValue = timeFilterElement.value;
      const filteredData = filterDataByTime(jsonData, timeValue);
      const aggregatedData = aggregateDataByTags(filteredData);

      const tags = Object.keys(aggregatedData);
      const values = Object.values(aggregatedData);

      const pieData = [{
          values: values,
          labels: tags,
          type: 'pie'
      }];

      Plotly.newPlot('pie-chart', pieData);
  }

  // –ù–∞—á–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
  updatePieChart();

</script>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>–†–µ–π—Ç–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</title>
</head>
<body>
  <div class="bd bgc-white">
    <div class="layers">
      <div class="layer w-100 p-20">
        <h3>–†–µ–π—Ç–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
        <div id="bar-chart" style="height: 400px;"></div>
      </div>
    </div>
  </div>

  <script>
    // var data = {
    //   users: Array.from({length: 100}, (_, i) => "User " + (i + 1)),
    //   ratings: Array.from({length: 100}, () => Math.floor(Math.random() * 100))
    // };
    var data = {{ data | safe }};

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–ø 50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –Ω–∞–∏–º–µ–Ω—å—à–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º
    var sortedIndices = data.ratings.map((rating, index) => index).sort((a, b) => data.ratings[a] - data.ratings[b]);
    var topUsers = sortedIndices.slice(0, 50).map(index => data.users[index]);
    var topRatings = sortedIndices.slice(0, 50).map(index => data.ratings[index]);

    // –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–æ–ª–±—á–∞—Ç–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã
    Plotly.newPlot('bar-chart', [{
      x: topUsers,
      y: topRatings,
      type: 'bar'
    }], {
      title: '–¢–æ–ø 50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –Ω–∞–∏–º–µ–Ω—å—à–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º',
      xaxis: {
        title: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
        tickfont: {
          size: 8 // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–µ–π –Ω–∞ –æ—Å–∏ X
        }
      },
      yaxis: {
        title: '–£—Ä–æ–≤–µ–Ω—å —Ä–µ–π—Ç–∏–Ω–≥–∞'
      }
    });
  </script>
</body>
</html>

<head>
  <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–µ–≥–∞–º</title>
</head>
<body>

<div class="bd bgc-white">
  <div class="layers">
      <div class="layer w-100 p-20">
          <h3>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –Ω–µ–¥–µ–ª—è–º</h3>
          <label for="uniqueTagSelector">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–≥: </label>
          <select id="uniqueTagSelector">
              <option value="all">–í—Å–µ —Ç–µ–≥–∏</option>
          </select>
          <div id="uniqueBarChart" style="height: 400px;"></div>
      </div>
  </div>
</div>

<script>
// const uniqueConstructiveData = {
//   '2023-W39': {'Tag1': 10, 'Tag2': 15},
//   '2023-W04': {'Tag1': 20, 'Tag2': 25},
//   '2023-W05': {'Tag221': 10, 'Tag2': 25},
//   '2023-W03': {'Tag111': 20, 'Tag234': 25}
// };
var uniqueConstructiveData = {{ uniqueConstructiveData | safe }};

// –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–µ–≥–æ–≤
const uniqueAllTags = new Set();
for (const weekData of Object.values(uniqueConstructiveData)) {
  for (const tag of Object.keys(weekData)) {
      uniqueAllTags.add(tag);
  }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–æ–≤ –≤ —Ñ–∏–ª—å—Ç—Ä
const uniqueTagSelector = document.getElementById('uniqueTagSelector');
uniqueAllTags.forEach(tag => {
  const option = document.createElement('option');
  option.value = tag;
  option.textContent = tag;
  uniqueTagSelector.appendChild(option);
});

function updateUniquePlot() {
  const selectedTag = uniqueTagSelector.value;
  const weeks = Object.keys(uniqueConstructiveData).sort();

  const values = weeks.map(week => {
      const weekData = uniqueConstructiveData[week];
      if (selectedTag === 'all') {
          const sum = Object.values(weekData).reduce((a, b) => a + b, 0);
          return sum / Object.keys(weekData).length;
      }
      return weekData[selectedTag] || 0;
  });

  const trace = {
      x: weeks,
      y: values,
      type: 'bar',
      name: selectedTag
  };

  const layout = {
      title: `–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –Ω–µ–¥–µ–ª—è–º`,
      xaxis: {title: '–ù–µ–¥–µ–ª—è'},
      yaxis: {title: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'}
  };

  Plotly.newPlot('uniqueBarChart', [trace], layout);
}

uniqueTagSelector.addEventListener('change', updateUniquePlot);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
updateUniquePlot();
</script>

</body>
<div class="bd bgc-white">
  <div class="layers">
      <div class="layer w-100 p-20">
          <h3>–¢–æ–∫—Å–∏—á–Ω–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –Ω–µ–¥–µ–ª—è–º</h3>
          <label for="toxicTagSelector">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–≥: </label>
          <select id="toxicTagSelector">
              <option value="all">–í—Å–µ —Ç–µ–≥–∏</option>
          </select>
          <div id="toxicBarChart" style="height: 400px;"></div>
      </div>
  </div>
</div>


<script>
// const toxicDataByWeek = {
//   '2023-W39': {'Tag1': 10, 'Tag2': 15},
//   '2023-W04': {'Tag1': 20, 'Tag2': 25},
//   '2023-W05': {'Tag221': 10, 'Tag2': 25},
//   '2023-W03': {'Tag111': 20, 'Tag234': 25}
// };
var toxicDataByWeek = {{ toxicDataByWeek | safe }};
// Populate list of unique tags
const allUniqueTags = new Set();
for (const weekData of Object.values(toxicDataByWeek)) {
  for (const tag of Object.keys(weekData)) {
      allUniqueTags.add(tag);
  }
}

// Populate tag filter
const toxicTagSelector = document.getElementById('toxicTagSelector');
allUniqueTags.forEach(tag => {
  const option = document.createElement('option');
  option.value = tag;
  option.textContent = tag;
  toxicTagSelector.appendChild(option);
});

function renderToxicPlot() {
  const selectedTag = toxicTagSelector.value;
  const weeks = Object.keys(toxicDataByWeek).sort();

  const values = weeks.map(week => {
      const weekData = toxicDataByWeek[week];
      if (selectedTag === 'all') {
          const sum = Object.values(weekData).reduce((a, b) => a + b, 0);
          return sum / Object.keys(weekData).length;
      }
      return weekData[selectedTag] || 0;
  });

  const trace = {
      x: weeks,
      y: values,
      type: 'bar',
      name: selectedTag
  };

  const layout = {
      title: `–¢–æ–∫—Å–∏—á–Ω–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –Ω–µ–¥–µ–ª—è–º`,
      xaxis: {title: '–ù–µ–¥–µ–ª—è'},
      yaxis: {title: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'}
  };

  Plotly.newPlot('toxicBarChart', [trace], layout);
}

toxicTagSelector.addEventListener('change', renderToxicPlot);

// Initialize the chart
renderToxicPlot();
</script>

</body>


      </div>
    </main>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}{% endblock javascripts %}
